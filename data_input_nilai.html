<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Data Raport Santri</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    select, button { padding: 5px 10px; font-size: 16px; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #f0f0f0; }
    button.print-btn { background-color: #4CAF50; color: white; border: none; padding: 5px 10px; cursor: pointer; }
    button.print-btn:hover { background-color: #45a049; }
  </style>
</head>
<body>

  <h2>üìä Data Raport Santri</h2>
  <label for="sheetSelector">Pilih Kelas:</label>
  <select id="sheetSelector" onchange="loadSheetData(this.value)">
    <option value="">-- Pilih Sheet --</option>
  </select>

  <div id="data" style="margin-top: 20px;">Silakan pilih sheet untuk menampilkan data.</div>

  <script>
    const baseURL = "https://script.google.com/macros/s/AKfycbytIfQIK2tZCA2U632Fz6YgvVt5kBC5c_YkP9oi0DgotDB_wLCE5nfeu6LbAWHL9nd0cg/exec";

    async function fetchSheets() {
      try {
        const response = await fetch(`${baseURL}?tipe=daftarSheet`);
        const sheets = await response.json();
        const selector = document.getElementById("sheetSelector");

        sheets.forEach(sheet => {
          const option = document.createElement("option");
          option.value = sheet;
          option.textContent = sheet;
          selector.appendChild(option);
        });
      } catch (error) {
        document.getElementById("data").innerHTML = "<i>Gagal memuat daftar sheet.</i>";
        console.error(error);
      }
    }

    async function loadSheetData(sheetName) {
      if (!sheetName) return;

      document.getElementById("data").innerHTML = "‚è≥ Memuat data...";
      try {
        const response = await fetch(`${baseURL}?tipe=dataSheet&sheet=${encodeURIComponent(sheetName)}`);
        const json = await response.json();

        const header = json.header || []; // header dari baris pertama sheet
        const data = json.data || [];

        if (header.length < 2) {
          document.getElementById("data").innerHTML = "<i>Header mapel tidak ditemukan di kolom pertama tabel.</i>";
          return;
        }

        if (data.length === 0) {
          document.getElementById("data").innerHTML = "<i>Data kosong.</i>";
          return;
        }

        // Buat tabel header
        let html = "<table><thead><tr><th>Nama</th>";
        header.slice(1).forEach(h => html += `<th>${h || "-"}</th>`);
        html += "<th>Aksi</th></tr></thead><tbody>";

        // Baris data
        data.forEach(row => {
          const nama = row.nama || "";
          const nilaiList = row.nilai || [];

          html += `<tr><td>${nama}</td>`;
          nilaiList.forEach(nilai => {
            html += `<td>${nilai === "" ? "" : nilai}</td>`;
          });

          // Buat parameter URL berdasarkan header dan nilai
          const params = new URLSearchParams();
          params.append("NAMA_MUSTAHIQ", nama);
          params.append("KELAS", sheetName);
          nilaiList.forEach((n, i) => {
            const key = header[i + 1] || `NILAI${i + 1}`;
            params.append(key, n || "");
          });

          html += `<td><button class="print-btn" onclick="window.open('print_layout.html?${params.toString()}', '_blank')">PRINT</button></td></tr>`;
        });

        html += "</tbody></table>";
        document.getElementById("data").innerHTML = html;

      } catch (error) {
        document.getElementById("data").innerHTML = "<i>Gagal memuat data sheet.</i>";
        console.error(error);
      }
    }

    fetchSheets();
  </script>

</body>
</html>
